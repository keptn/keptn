name: Integration Tests
on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: '0 3 * * 1-5' # run integration tests at 3 AM, monday to friday (1-5)

  workflow_dispatch: # run integration tests only when triggered manually
    inputs:
      branch:
        description: 'Take CI build artifacts from branch (e.g., master, release-x.y.z)'
        required: true
        default: 'master'
      examples_branch:
        description: 'Branch of Keptn examples to use for integration tests (e.g., master, release-x.y.z)'
        required: true
        default: 'master'
env:
  META_KEPTN_VERSION: 0.10.0
  META_KEPTN_KEPTN_PROJECT: keptn
defaults:
  run:
    shell: bash
jobs:
  #######################################################################
  # This job deploys Keptn with Keptn                                   #
  #######################################################################
  deploy_keptn_with_keptn:
    name: Deploy Keptn with Keptn
#    if: github.event_name == 'schedule'
    runs-on: ubuntu-20.04
    env:
      BRANCH: "chore/upgrade-meta-keptn"
    steps:
      - name: Check out code
        uses: actions/checkout@v2.4.0
        with:
          fetch-depth: 0 # need to checkout "all commits" for certain features to work (e.g., get all changed files)
          submodules: 'true'

      - name: Download all artifacts from last successful build of specified branch
        uses: dawidd6/action-download-artifact@v2.15.0
        with:
          # Download last successful artifact from a CI build
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: CI.yml
          run_id: "1449045011"
          # directory where to extract artifacts to
          path: ./dist

      - name: Load Build-Config Environment from ./dist/build-config/build-config.env
        id: load_build_env
        uses: c-py/action-dotenv-to-setenv@v3
        with:
          env-file: ./dist/build-config/build-config.env

      - name: Overwrite VERSION String for nightly builds
        if: env.BRANCH == 'master'
        run: |
          # use VERSION.DATETIME for the cli version (e.g., nightly build)
          VERSION=${VERSION}.${DATETIME}
          # overwrite VERSION
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: DEBUG Build-Config
        run: |
          echo VERSION=${VERSION}
          echo BRANCH=${BRANCH}

      - name: Install Keptn CLI for META_KEPTN
        id: install_keptn_cli
        run: |
          curl -sL https://get.keptn.sh | KEPTN_VERSION=${{ env.META_KEPTN_VERSION }} bash

      - name: Authenticate Keptn CLI
        id: authenticate_keptn_cli
        run: |
          keptn set config KubeContextCheck false
          keptn auth --endpoint=${{ secrets.META_KEPTN_API_URL }} --api-token=${{ secrets.META_KEPTN_API_TOKEN }}

      - name: Deploy Keptn with Keptn
        id: deploy_keptn_with_keptn
        run: |
          KEPTN_HELM_CHART_FILENAME=$(ls dist/keptn-installer/keptn*.tgz | head -1)
          KEPTN_INGRESS_TEMPLATE_FILENAME=test/assets/keptn-on-keptn/ingress.yaml
          ENDPOINTS_TEMPLATE_BASE_PATH=test/assets/keptn-on-keptn
          HELM_SERVICE_HELM_CHART_FILENAME=$(ls dist/keptn-installer/helm-service*.tgz | head -1)
          JMETER_SERVICE_HELM_CHART_FILENAME=$(ls dist/keptn-installer/jmeter-service*.tgz | head -1)

          echo "Adding resources to meta keptn..."

          keptn add-resource --project=${{ env.META_KEPTN_KEPTN_PROJECT }} --service=keptn --all-stages --resource=${KEPTN_HELM_CHART_FILENAME} --resourceUri=helm/keptn.tgz
          keptn add-resource --project=${{ env.META_KEPTN_KEPTN_PROJECT }} --service=helm-service --all-stages --resource=${HELM_SERVICE_HELM_CHART_FILENAME} --resourceUri=helm/helm-service.tgz
          keptn add-resource --project=${{ env.META_KEPTN_KEPTN_PROJECT }} --service=jmeter-service --all-stages --resource=${JMETER_SERVICE_HELM_CHART_FILENAME} --resourceUri=helm/jmeter-service.tgz

          echo "Adding ingresses and endpoints to all keptn-on-keptn stages..."

          stages=('dev' 'hardening' 'production')
          services=('keptn' 'helm-service' 'jmeter-service')
          for SERVICE in "${services[@]}"; do
            for STAGE in "${stages[@]}"; do
              export SERVICE
              export STAGE
              envsubst < ${ENDPOINTS_TEMPLATE_BASE_PATH}/endpoints-${SERVICE}.yaml > ${ENDPOINTS_TEMPLATE_BASE_PATH}/endpoints-${SERVICE}-${STAGE}.yaml
              keptn add-resource \
                --project=${{ env.META_KEPTN_KEPTN_PROJECT }} \
                --service=${SERVICE} \
                --stage=${STAGE} \
                --resource=${ENDPOINTS_TEMPLATE_BASE_PATH}/endpoints-${SERVICE}-${STAGE}.yaml \
                --resourceUri=helm/endpoints.yaml
            done
          done

          for STAGE in "${stages[@]}"; do
            export STAGE
            envsubst < ${KEPTN_INGRESS_TEMPLATE_FILENAME} > ${ENDPOINTS_TEMPLATE_BASE_PATH}/ingress-${STAGE}.yaml
            keptn add-resource \
              --project=${{ env.META_KEPTN_KEPTN_PROJECT }} \
              --service=keptn \
              --stage=${STAGE} \
              --resource=${ENDPOINTS_TEMPLATE_BASE_PATH}/ingress-${STAGE}.yaml \
              --resourceUri=helm/keptn/templates/ingress.yaml
          done

  #######################################################################
  # This job triggers service deliveries and wait for them to pass      #
  #######################################################################
  trigger_keptn_delivery:
    name: Trigger Service Delivery
    needs: deploy_keptn_with_keptn
#    if: github.event_name == 'schedule'
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        include:
          - SERVICE_NAME: keptn
          - SERVICE_NAME: jmeter-service
          - SERVICE_NAME: helm-service
    env:
      SERVICE_NAME: ${{ matrix.SERVICE_NAME }}
      KEPTN_ARCHIVE_PATH: ~/downloads/keptn-archive.tar.gz
    steps:
      - name: Create downloads folder
        run: mkdir ~/downloads

      - name: Download all artifacts from last successful build of specified branch
        uses: dawidd6/action-download-artifact@v2.15.0
        with:
          # Download last successful artifact from a CI build
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: CI.yml
          run_id: "1449045011"
          # directory where to extract artifacts to
          path: ./dist

      # load build-config
      - name: Load Build-Config Environment from ./dist/build-config/build-config.env
        id: load_build_env
        uses: c-py/action-dotenv-to-setenv@v3
        with:
          env-file: ./dist/build-config/build-config.env

      - name: Overwrite VERSION String for nightly builds
        run: |
          if [[ "$BRANCH" == "master" ]]; then
            # use VERSION.DATETIME for the cli version (e.g., nightly build)
            VERSION=${VERSION}.${DATETIME}
            # overwrite VERSION
            echo "VERSION=${VERSION}" >> $GITHUB_ENV
          fi

      - name: DEBUG Build-Config
        run: |
          echo VERSION=${VERSION}
          echo BRANCH=${BRANCH}

      - name: Cache Keptn CLI
        id: keptn-cli-cache
        uses: actions/cache@v2
        with:
          path: ~/downloads
          key: ${{ env.META_KEPTN_VERSION }}-cli

      - name: Download Keptn CLI for META_KEPTN
        id: download_keptn_cli
        if: steps.keptn-cli-cache.outputs.cache-hit != 'true'
        run: curl -sL https://github.com/keptn/keptn/releases/download/${META_KEPTN_VERSION}/keptn-${META_KEPTN_VERSION}-linux-amd64.tar.gz -o ${{ env.KEPTN_ARCHIVE_PATH }}

      - name: Install Keptn CLI for META_KEPTN
        id: install_keptn_cli
        run: |
          tar -xvf ${{ env.KEPTN_ARCHIVE_PATH }}
          chmod +x ./keptn-${META_KEPTN_VERSION}-linux-amd64
          sudo mv ./keptn-${META_KEPTN_VERSION}-linux-amd64 /usr/local/bin/keptn

      - name: Authenticate Keptn CLI
        id: authenticate_keptn_cli
        run: |
          keptn set config KubeContextCheck false
          keptn auth --endpoint=${{ secrets.META_KEPTN_API_URL }} --api-token=${{ secrets.META_KEPTN_API_TOKEN }}

      - name: Trigger Service Delivery
        id: trigger-service-delivery
        uses: keptn/gh-action-send-event@main
        with:
          keptnApiUrl: ${{ secrets.META_KEPTN_API_URL }}/v1/event
          keptnApiToken: ${{ secrets.META_KEPTN_API_TOKEN }}
          event: |
            {
              "data": {
                "message": "",
                "project": "${{ env.META_KEPTN_KEPTN_PROJECT }}",
                "result": "",
                "service": "${{ env.SERVICE_NAME }}",
                "stage": "dev",
                "status": "",
                "labels": {
                  "github-action-run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "artifact-version": "${{ env.VERSION }}"
                }
              },
              "source": "gh",
              "specversion": "1.0",
              "type": "sh.keptn.event.dev.delivery.triggered",
              "shkeptnspecversion": "0.2.1"
            }

      - name: Check if keptn on keptn delivery passed
        id: check-service-delivery
        timeout-minutes: 5
        env:
          KEPTN_CONTEXT: ${{ steps.trigger-service-delivery.outputs.keptnContext }}
        run: |
          while [[ $(keptn get event sh.keptn.event.dev.delivery.finished --keptn-context "$KEPTN_CONTEXT" --project keptn | jq -r '.data.result' 2>/dev/null) != pass ]]; do
            sleep 10;
          done
