name: Build Docker Images
on:
  workflow_call:
    inputs:
      matrix:
        type: string
        required: true
      version:
        type: string
        required: true
      datetime:
        type: string
        required: false
        default: ''
      gitSha: 
        type: string
        required: true
        default: ''
      buildeverything:
        type: boolean
        required: false
        default: false
defaults:
  run:
    shell: bash
jobs:
  build_and_push_image:
    name: Build and Push Docker images
    runs-on: ubuntu-20.04
    strategy:
      matrix: ${{ fromJson( inputs.matrix ) }}
    env:
      VERSION: ${{ inputs.version }}
      DATETIME: ${{ inputs.datetime }}
      GIT_SHA: ${{ inputs.gitSha }}
      BUILD_EVERYTHING: ${{ inputs.buildeverything }}
    steps:
    - name: Output matrix
      run: echo $matrix

    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2
      with:
          install: true
    
    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        # Key is named differently to avoid collision
        key: ${{ runner.os }}-multi-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-multi-buildx

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      # only run docker login on pushes; also for PRs, but only if this is not a fork
      if: ( github.actor != 'renovate[bot]' && github.actor != 'dependabot[bot]' ) && (matrix.config.should-push-image == 'true' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository))
      # note: GH does not allow to access secrets for PRs from a forked repositories due to security reasons
      # that's fine, but it means we can't push images to dockerhub
      with:
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: "Docker Build keptn/${{ matrix.config.artifact }}"
      id: docker_build_image
      if: matrix.config.should-push-image == 'true' && ( matrix.config.should-run == 'true' || env.BUILD_EVERYTHING == 'true' )
      uses: docker/build-push-action@v3
      with:
        context: ${{ matrix.config.working-dir }}
        tags: |
          keptndev/${{ matrix.config.artifact }}:${{ env.VERSION }}
          keptndev/${{ matrix.config.artifact }}:${{ env.VERSION }}.${{ env.DATETIME }}
        build-args: |
          version=${{ env.VERSION }}
          buildTime=${{ env.DATETIME }}
          gitSha=${{ env.GIT_SHA }}
        push: ${{ matrix.config.should-push-image == 'true' && (( github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository ) || ( github.event_name == 'push' )) && github.actor != 'renovate[bot]' && github.actor != 'dependabot[bot]' }}
        pull: true
        builder: ${{ steps.buildx.outputs.name }}
        cache-from: type=gha, scope=${{ github.workflow }}
        cache-to: type=gha, scope=${{ github.workflow }}