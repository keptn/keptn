sudo: true
os: osx
language: go
go:
  - 1.12.x
cache:
  directories:
    - "$HOME/google-cloud-sdk/"
services:
  - docker
env:
  global:
    - GOOGLE_APPLICATION_CREDENTIALS=~/gcloud-service-key.json
    - DEP_VERSION="0.5.3"
notifications:
  webhooks:
    urls:
      - https://us-central1-sai-research.cloudfunctions.net/travisWebhookListener
    on_failure: always
    on_cancel: always
    on_error: always 
before_install:      
# Download the binary to bin folder in $GOPATH
- curl -L -s https://github.com/golang/dep/releases/download/v${DEP_VERSION}/dep-darwin-amd64 -o $GOPATH/bin/dep
# Make the binary executable
- chmod +x $GOPATH/bin/dep
- cd cli/
- dep ensure
- cd ..
- export TZ=Europe/Vienna
- REGISTRY_USER=jbraeuer
- CLI_VERSION="$(cat ./cli/version | tr -d '[:space:]')"
- DATE="$(date +'%Y%m%d.%H%M')"
- GIT_SHA="$(git rev-parse --short HEAD)"
- echo "$REGISTRY_PASSWORD" | docker login --username $REGISTRY_USER --password-stdin
- REPO_URL="$(git remote get-url --all origin)"

jobs:
  include:
  - stage: cron
    if: branch = develop AND type = cron
    script:
    - git clone --branch develop https://github.com/keptn/installer.git --single-branch
    - source travis-scripts/cronjob_main.sh
  - stage: feature/bug/hotfix
    if: branch =~ ^feature.*$ OR branch =~ ^bug.*$ OR branch =~ ^hotfix.*$
    script:
    - echo $TRAVIS_BUILD_STAGE_NAME
    - TYPE="$(echo $TRAVIS_BRANCH | cut -d'/' -f1)"
    - NUMBER="$(echo $TRAVIS_BRANCH | cut -d'/' -f2)"
    - travis-scripts/setup_gcloud.sh
    - cd ./cli
    - TAG="${TYPE}-${NUMBER}-${DATE}"
    - source ../travis-scripts/build_cli.sh "${TAG}"
  - stage: develop
    if: branch = develop AND type = push
    script: 
    - echo $TRAVIS_BUILD_STAGE_NAME
    - travis-scripts/setup_gcloud.sh
    - cd ./cli
    - TAG="${DATE}-latest"
    - source ../travis-scripts/build_cli.sh "${TAG}"  
  - stage: release
    if: branch =~ ^release.*$ AND NOT type = pull_request
    script:
    - echo $TRAVIS_BUILD_STAGE_NAME
    - travis-scripts/setup_gcloud.sh
    - cd ./cli
    - TAG="${CLI_VERSION}-${DATE}"
    - source ../travis-scripts/build_cli.sh "${TAG}"  
  - stage: master
    if: branch = master AND NOT type = pull_request
    script:
    - echo $TRAVIS_BUILD_STAGE_NAME
    - travis-scripts/setup_gcloud.sh
    - cd ./cli
    - TAG="${CLI_VERSION}"
    - source ../travis-scripts/build_cli.sh "${TAG}"  
